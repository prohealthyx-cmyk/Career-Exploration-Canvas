import React, { useState, useEffect } from 'react';

export default function CareerExplorationCanvas() {
  const STORAGE = 'cec_store_v5';
  const uid = () => Math.random().toString(36).slice(2, 9);
  const emptyStore = () => ({ step: 1, answers: {}, options: [], criteria: [], ratings: {}, plan: [] });
  const [store, setStore] = useState(emptyStore());

  useEffect(() => {
    try {
      const raw = localStorage.getItem(STORAGE);
      if (raw) setStore(JSON.parse(raw));
    } catch {}
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem(STORAGE, JSON.stringify(store));
    } catch {}
  }, [store]);

  const progress = (store.step / 4) * 100;

  const resetAll = () => {
    const fresh = emptyStore();
    try {
      localStorage.setItem(STORAGE, JSON.stringify(fresh));
    } catch {}
    setStore(fresh);
  };

  const Question = ({ id, label }) => (
    <div className="p-4 border rounded-xl bg-white mb-3">
      <p className="font-medium mb-1">{label}</p>
      <textarea
        value={store.answers[id] || ''}
        onChange={(e) => setStore((st) => ({ ...st, answers: { ...st.answers, [id]: e.target.value } }))}
        placeholder="Write your response here..."
        className="w-full p-2 border rounded-lg"
      />
    </div>
  );

  return (
    <div className="max-w-3xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-2">Career Exploration Canvas</h1>
      <p className="text-slate-600 mb-4">
        Guided reflection to expand possibilities, gain clarity, and choose directions.
      </p>

      <div className="h-2 bg-slate-200 rounded-full overflow-hidden mb-4">
        <div className="bg-blue-600 h-full" style={{ width: `${progress}%` }} />
      </div>

      {store.step === 1 && (
        <div>
          <h3 className="text-lg font-semibold mb-3">🌍 Step 1 – Expand the Map</h3>
          {[
            'What activities make you lose track of time?',
            'If you had to teach something, what would it be?',
            'What work environment stimulates you?',
            'If money wasn’t an issue, what would you do for a year?',
            'What problems are you drawn to solve?',
          ].map((q, i) => (
            <Question key={i} id={`q${i + 1}`} label={q} />
          ))}
        </div>
      )}

      {store.step === 2 && (
        <div>
          <h3 className="text-lg font-semibold mb-3">🎯 Step 2 – Define Your Criteria</h3>
          <p className="text-slate-600 mb-3 text-sm">
            Define what truly matters to you. Add your key criteria (e.g., Impact, Growth, Autonomy, Creativity,
            Balance) and reflect on why they’re important.
          </p>
          <Question id="criteria" label="What are your top 5 criteria?" />
        </div>
      )}

      {store.step === 3 && (
        <div>
          <h3 className="text-lg font-semibold mb-3">🧭 Step 3 – Converge and Reflect</h3>
          <Question id="reflection" label="Which 3 options make you feel most alive?" />
          <Question id="nextStep" label="What’s one small experiment you can do to explore one of them?" />
        </div>
      )}

      {store.step === 4 && (
        <div>
          <h3 className="text-lg font-semibold mb-3">📝 Report</h3>
          <p>Your reflections have been saved locally in your browser.</p>
          <pre className="bg-slate-50 p-4 rounded-xl text-sm overflow-x-auto">
            {JSON.stringify(store.answers, null, 2)}
          </pre>
        </div>
      )}

      <div className="flex justify-between mt-4">
        <button
          onClick={() => setStore((st) => ({ ...st, step: Math.max(1, st.step - 1) }))}
          disabled={store.step === 1}
          className="px-4 py-2 bg-slate-200 rounded-lg disabled:opacity-50"
        >
          Back
        </button>
        <div className="flex gap-2">
          <button onClick={resetAll} className="px-4 py-2 bg-red-500 text-white rounded-lg">
            Reset
          </button>
          <button
            onClick={() => setStore((st) => ({ ...st, step: Math.min(4, st.step + 1) }))}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg"
          >
            {store.step < 4 ? 'Next' : 'Finish'}
          </button>
        </div>
      </div>
    </div>
  );
}
